<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LivestockMart - User App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; overscroll-behavior-y: contain; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .auth-glass { background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(18px); }
        .auth-card { position: relative; overflow-y: auto; overflow-x: hidden; max-height: 85vh; }
        .auth-panel { transition: transform 0.45s ease, opacity 0.45s ease; width: 100%; }
        .auth-panel-register { position: absolute; top: 0; left: 0; transform: translateX(100%); opacity: 0; pointer-events: none; }
        .auth-card.show-register .auth-panel-login { transform: translateX(-100%); opacity: 0; pointer-events: none; }
        .auth-card.show-register .auth-panel-register { transform: translateX(0); opacity: 1; pointer-events: auto; position: relative; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        .lm-flyin { transform: translateY(18px); opacity: 0; transition: transform 360ms cubic-bezier(.2,.9,.2,1), opacity 360ms; }
        .lm-flyin.lm-show { transform: translateY(0); opacity: 1; }
        .page-enter { opacity: 0; transform: translateY(20px); }
        .page-enter-active { opacity: 1; transform: translateY(0); transition: all .6s cubic-bezier(.16,.67,.43,1); }
        .card-premium { transition: transform .35s cubic-bezier(.2,.9,.2,1), box-shadow .35s; }
        .card-premium:hover { transform: translateY(-6px) scale(1.03); box-shadow: 0 18px 40px rgba(0,0,0,0.15); }
        .reveal { opacity: 0; transform: translateY(25px); transition: all .7s cubic-bezier(.2,.9,.2,1); }
        .reveal-visible { opacity: 1; transform: translateY(0); }
        .toast-anim { transform: translateX(20px); opacity: 0; animation: toastIn .4s forwards, toastOut .4s forwards 3s; }
        @keyframes toastIn { to { transform: translateX(0); opacity: 1; } }
        @keyframes toastOut { to { transform: translateX(30px); opacity: 0; } }
        .btn-press { transition: transform .15s ease, box-shadow .3s ease; }
        .btn-press:active { transform: scale(.96); }
        .btn-glow:hover { box-shadow: 0 0 12px rgba(16,185,129,0.6); }
    </style>
</head>
<body class="h-screen bg-gray-900 text-gray-100 overflow-hidden">
    
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-3 pointer-events-none"></div>
    
    <div id="address-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 px-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md text-gray-800 shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold" id="address-modal-title">Shipping Address</h3>
                <button onclick="closeAddressModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <p class="text-xs text-gray-500 mb-4">Enter the address where you want to receive your livestock.</p>
            <div class="pr-1">
                <form id="address-form" class="space-y-3" onsubmit="submitAddress(event)">
                    <div><label class="block text-xs font-medium text-gray-700">Full Name</label><input id="addr-name" type="text" class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" required></div>
                    <div><label class="block text-xs font-medium text-gray-700">Phone Number</label><input id="addr-phone" type="tel" pattern="[0-9]{10}" maxlength="10" class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="10-digit mobile number" required></div>
                    <div><label class="block text-xs font-medium text-gray-700">Address Line</label><textarea id="addr-line" class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" rows="2" required></textarea></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-medium text-gray-700">City</label><input id="addr-city" type="text" class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" required></div>
                        <div><label class="block text-xs font-medium text-gray-700">State</label><input id="addr-state" type="text" class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" required></div>
                    </div>
                    <div><label class="block text-xs font-medium text-gray-700">Pincode</label><input id="addr-pincode" type="tel" pattern="[0-9]{6}" maxlength="6" class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="6-digit pincode" required></div>
                    <div class="mt-4 flex justify-end gap-3 pb-2">
                        <button type="button" onclick="closeAddressModal()" class="px-4 py-2 text-sm rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 text-sm rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Save & Continue</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="track-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 px-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg text-gray-800 shadow-2xl relative">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold">Track Order</h3>
                <button onclick="closeTrackModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="track-content" class="space-y-6"></div>
        </div>
    </div>
    
    <div id="auth-screen" class="hidden fixed inset-0 z-40 flex items-center justify-center px-4 bg-gradient-to-br from-green-900 via-gray-900 to-black overflow-y-auto py-8">
        <div class="max-w-5xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 items-stretch my-auto">
            <div class="hidden md:flex flex-col justify-between text-white">
                <div>
                    <div class="flex items-center gap-3 mb-6"><div class="w-10 h-10 rounded-full bg-emerald-500 flex items-center justify-center font-bold text-lg">L</div><span class="text-2xl font-bold tracking-tight">LivestockMart</span></div>
                    <h1 class="text-3xl md:text-4xl font-bold leading-tight mb-4">Manage your goats & sheep<br>like a modern marketplace.</h1>
                    <p class="text-sm text-emerald-100/80">Realtime livestock listings, smart orders, and a smooth shopping experience.</p>
                </div>
            </div>
            <div id="auth-card" class="auth-card auth-glass rounded-3xl p-6 sm:p-8 shadow-2xl border border-white/10 hide-scrollbar">
                <div class="auth-panel auth-panel-login">
                    <div class="flex items-center gap-3 mb-4"><div class="w-9 h-9 rounded-full bg-emerald-500/20 flex items-center justify-center"><i data-lucide="lock" class="w-4 h-4 text-emerald-400"></i></div><div><h2 class="text-xl font-semibold">Welcome back</h2><p class="text-xs text-gray-300">Sign in to access your dashboard</p></div></div>
                    <form id="login-form" class="space-y-4 mt-4">
                        <div class="space-y-1.5"><label class="text-xs font-medium text-gray-200">Email</label><input id="login-email" type="email" required class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="you@example.com"></div>
                        <div class="space-y-1.5"><label class="text-xs font-medium text-gray-200">Password</label><input id="login-password" type="password" required class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                        <button type="submit" class="w-full mt-2 inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold text-white py-2.5 transition-transform active:scale-[0.98]"><span>Sign in</span><i data-lucide="log-in" class="w-4 h-4"></i></button>
                    </form>
                    <div class="mt-4 text-xs text-gray-300 flex items-center justify-between"><span>New here?</span><button type="button" onclick="switchAuthView('register')" class="text-emerald-300 hover:text-emerald-200 font-medium">Create an account</button></div>
                </div>
                <div class="auth-panel auth-panel-register">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3"><div class="w-9 h-9 rounded-full bg-emerald-500/20 flex items-center justify-center"><i data-lucide="user-plus" class="w-4 h-4 text-emerald-400"></i></div><div><h2 class="text-xl font-semibold">Create account</h2><p class="text-xs text-gray-300">Join the marketplace</p></div></div>
                        <button onclick="switchAuthView('login')" class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-white/10 transition"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                    </div>
                    <form id="register-form" class="space-y-4 mt-4">
                        <div class="space-y-1.5"><label class="text-xs font-medium text-gray-200">Full Name</label><input id="register-name" type="text" required class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Alex Johnson"></div>
                        <div class="space-y-1.5"><label class="text-xs font-medium text-gray-200">Email</label><input id="register-email" type="email" required class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="you@example.com"></div>
                        <div class="space-y-1.5"><label class="text-xs font-medium text-gray-200">Password</label><input id="register-password" type="password" required class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Create a strong password"></div>
                        <button type="submit" class="w-full mt-2 inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold text-white py-2.5 transition-transform active:scale-[0.98]"><span>Create account</span><i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                    </form>
                    <div class="mt-4 text-xs text-gray-300 flex items-center justify-between"><span>Already registered?</span><button type="button" onclick="switchAuthView('login')" class="text-emerald-300 hover:text-emerald-200 font-medium">Back to login</button></div>
                </div>
                <div id="auth-error" class="mt-4 text-xs text-red-300 hidden"></div>
            </div>
        </div>
    </div>
    
    <div id="user-app" class="hidden h-[100dvh] w-full bg-gray-50 text-gray-800 flex overflow-hidden">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-white border-r border-gray-200 flex flex-col transform -translate-x-full md:translate-x-0 md:relative transition-transform duration-200 ease-in-out shadow-xl md:shadow-none h-full">
            <div class="p-6 flex items-center justify-between gap-3 flex-shrink-0">
                <div class="flex items-center gap-3"><div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white font-bold">L</div><span class="text-xl font-bold text-gray-800">LivestockMart</span></div>
                <button onclick="toggleSidebar()" class="md:hidden text-gray-500 hover:text-red-500"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <nav class="flex-1 px-4 space-y-2 overflow-y-auto min-h-0 pb-24 md:pb-4">
                <button onclick="router('browse')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"><i data-lucide="home" class="w-5 h-5 flex-shrink-0"></i> Browse Livestock</button>
                <button onclick="router('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"><i data-lucide="layout-dashboard" class="w-5 h-5 flex-shrink-0"></i> My Dashboard</button>
                <button onclick="router('cart')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"><i data-lucide="shopping-cart" class="w-5 h-5 flex-shrink-0"></i> Shopping Cart<span id="cart-badge" class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span></button>
                <button onclick="router('orders')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"><i data-lucide="package" class="w-5 h-5 flex-shrink-0"></i> My Orders</button>
                <button onclick="router('wishlist')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"><i data-lucide="heart" class="w-5 h-5 flex-shrink-0"></i> Wishlist<span id="wishlist-badge" class="ml-auto bg-pink-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span></button>
                <button onclick="router('addresses')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"><i data-lucide="map-pin" class="w-5 h-5 flex-shrink-0"></i> Addresses</button>
                <button onclick="router('profile')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"><i data-lucide="user" class="w-5 h-5 flex-shrink-0"></i> Profile</button>
                <button onclick="router('support')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"><i data-lucide="headphones" class="w-5 h-5 flex-shrink-0"></i> Support</button>
            </nav>
        </aside>

        <main id="main-content" class="flex-1 flex flex-col relative overflow-hidden w-full h-full">
            <header class="bg-white border-b border-gray-200 px-4 md:px-8 py-4 flex justify-between items-center z-10 sticky top-0 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="md:hidden text-gray-600 hover:text-green-600"><i data-lucide="menu" class="w-6 h-6"></i></button>
                    <div class="overflow-hidden"><h1 id="page-title" class="text-lg md:text-2xl font-bold text-gray-800 truncate">My Dashboard</h1><p class="text-xs md:text-sm text-gray-500 hidden sm:block" id="current-date"></p></div>
                </div>
                <div class="flex items-center gap-3 md:gap-6">
                    <div class="relative">
                        <button id="notification-button" onclick="toggleNotificationMenu()" class="focus:outline-none p-2 rounded-full hover:bg-gray-100 transition relative"><i data-lucide="bell" class="w-6 h-6 text-gray-600 pointer-events-none"></i><span id="notification-badge" class="absolute top-1 right-1 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full hidden pointer-events-none">0</span></button>
                        <div id="notification-menu" class="absolute right-[-60px] md:right-0 mt-2 w-72 max-w-[92vw] bg-white border border-gray-100 rounded-xl shadow-xl py-2 hidden origin-top-right transform transition-all duration-300 scale-95 opacity-0 z-50">
                            <div class="flex justify-between items-center px-4 pt-2 pb-1 border-b border-gray-100"><h4 class="font-semibold text-sm text-gray-800">Notifications</h4><button onclick="clearAllNotifications()" class="text-xs text-blue-500 hover:text-blue-700 disabled:opacity-50" id="clear-all-btn" disabled>Clear All</button></div>
                            <div id="notification-list" class="max-h-64 overflow-y-auto space-y-1 p-2"><p class="text-center text-xs text-gray-400 py-4" id="no-notifications-msg">No new notifications.</p></div>
                        </div>
                    </div>
                    <div class="relative cursor-pointer" onclick="router('cart')"><i data-lucide="shopping-cart" class="w-6 h-6 text-gray-600"></i><span id="header-cart-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full hidden">0</span></div>
                    <div class="relative">
                        <button id="profile-button" onclick="toggleProfileMenu()" class="flex items-center gap-2 md:gap-3 focus:outline-none">
                            <div id="profile-avatar" class="w-9 h-9 md:w-10 md:h-10 bg-green-100 rounded-full flex items-center justify-center text-green-700 font-bold text-sm md:text-base flex-shrink-0">U</div>
                            <div class="hidden md:block text-left"><p id="profile-name" class="text-sm font-semibold truncate max-w-[100px]">User</p><p id="profile-meta" class="text-xs text-gray-500">Welcome</p></div><i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 hidden md:block"></i>
                        </button>
                        <div id="profile-menu" class="absolute right-0 mt-2 w-44 bg-white border border-gray-100 rounded-lg shadow-lg py-1 hidden z-50">
                            <button onclick="router('profile'); toggleProfileMenu(false);" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2"><i data-lucide="user" class="w-4 h-4"></i><span>Profile</span></button>
                            <button onclick="handleLogout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i><span>Logout</span></button>
                        </div>
                    </div>
                </div>
            </header>
            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50 hide-scrollbar relative pb-24">
                <div id="view-dashboard" class="space-y-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500 mb-1">My Orders</p><h3 class="text-2xl font-bold text-gray-800" id="dash-total-orders">0</h3></div><div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xl">üì¶</div></div>
                        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500 mb-1">Wishlist</p><h3 class="text-2xl font-bold text-gray-800" id="dash-total-wishlist">0</h3></div><div class="w-12 h-12 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center text-xl">‚ù§Ô∏è</div></div>
                        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500 mb-1">Cart Items</p><h3 class="text-2xl font-bold text-gray-800" id="dash-total-cart">0</h3></div><div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-xl">üõí</div></div>
                        <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500 mb-1">Total Livestock</p><h3 class="text-2xl font-bold text-gray-800" id="dash-total-livestock">0</h3></div><div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-xl">üêê</div></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm"><div class="flex justify-between items-center"><div><p class="text-sm text-gray-500 mb-1">Total Spent</p><h3 class="text-2xl md:text-3xl font-bold text-gray-800" id="dash-total-spent">0</h3></div><div class="w-12 h-12 md:w-16 md:h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center text-2xl md:text-3xl">üí∞</div></div></div>
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm"><div class="p-6 border-b border-gray-200"><h3 class="font-bold text-gray-800">Recent Orders</h3></div><div class="p-4 md:p-6 space-y-4" id="dash-recent-orders"></div></div>
                </div>
                <div id="view-browse" class="hidden space-y-6">
                    <div class="flex flex-col md:flex-row gap-4 justify-between">
                        <div class="relative flex-1 w-full md:max-w-md"><i data-lucide="search" class="absolute left-3 top-3 w-5 h-5 text-gray-400"></i><input type="text" id="search-input" oninput="renderBrowse()" placeholder="Search by name or breed..." class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></div>
                        <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                            <button onclick="filterCategory('All')" class="filter-btn px-4 py-2 bg-gray-800 text-white rounded-lg text-sm font-medium whitespace-nowrap">All</button>
                            <button onclick="filterCategory('Goat')" class="filter-btn px-4 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-50 whitespace-nowrap">Goats</button>
                            <button onclick="filterCategory('Sheep')" class="filter-btn px-4 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-50 whitespace-nowrap">Sheep</button>
                        </div>
                    </div>
                    <div id="livestock-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
                <div id="view-cart" class="hidden space-y-6">
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 md:p-6">
                        <h3 class="font-bold text-lg mb-6">Shopping Cart <span id="cart-count-title" class="text-gray-400 text-sm font-normal">(0 items)</span></h3>
                        <div id="cart-items-container" class="space-y-6"><div class="text-center py-10 text-gray-400">Your cart is empty</div></div>
                        <div class="mt-8 pt-6 border-t border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4"><h3 class="text-xl font-bold">Total: <span id="cart-total">0</span></h3><button onclick="checkout()" class="w-full sm:w-auto bg-gray-800 text-white px-8 py-3 rounded-lg font-medium hover:bg-gray-900 transition">Proceed to Checkout</button></div>
                    </div>
                </div>
                <div id="view-orders" class="hidden space-y-6"><div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 md:p-6"><h3 class="font-bold text-lg mb-6">Order History</h3><div class="space-y-4" id="orders-list-full"></div></div></div>
                <div id="view-wishlist" class="hidden space-y-6"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-xl">My Wishlist</h3></div><div id="wishlist-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
                <div id="view-addresses" class="hidden space-y-6"><div class="bg-white p-4 md:p-6 rounded-xl border shadow-sm"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">Saved Addresses</h3><button onclick="openAddressModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition"><i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> Add New</button></div><div id="addresses-container" class="space-y-4"></div></div></div>
                <div id="view-profile" class="hidden space-y-6">
                    <div class="bg-white p-4 md:p-6 rounded-xl border shadow-sm"><h3 class="font-bold text-lg mb-4">Profile Settings</h3><div class="space-y-4 max-w-md"><div><label class="block text-sm font-medium text-gray-700">Full Name</label><input id="profile-name-input" type="text" value="" disabled class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100 cursor-not-allowed"></div><div><label class="block text-sm font-medium text-gray-700">Email</label><input id="profile-email-input" type="email" value="" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" disabled></div><p class="text-xs text-gray-400">Profile is based on your login data.</p></div></div>
                </div>
                <div id="view-support" class="hidden space-y-6"><div class="bg-white p-6 rounded-xl border shadow-sm text-center py-12"><i data-lucide="headphones" class="w-12 h-12 mx-auto text-green-600 mb-4"></i><h3 class="font-bold text-lg">Need Help?</h3><p class="text-gray-500 mb-4">Contact our support team 24/7</p><button class="bg-green-600 text-white px-6 py-2 rounded-full">Start Chat</button></div></div>
            </div>
        </main>
    </div>
    <script>
        const API_URL = 'https://goat-user.vercel.app/api';
        let livestock=[], orders=[], cart=[], wishlist=[], addresses=[], notifications=[], currentCategory='All', currentUser=null, appInitialized=false, currentAddress=null, pendingCheckoutItems=null, editingAddressIndex=-1;
        
        function toggleSidebar(){ const s=document.getElementById('sidebar'), o=document.getElementById('mobile-overlay'); if(s.classList.contains('-translate-x-full')){ s.classList.remove('-translate-x-full'); o?.classList.remove('hidden'); } else { s.classList.add('-translate-x-full'); o?.classList.add('hidden'); } }
        let previousLivestockCount=parseInt(localStorage.getItem('lm_prev_ls_count')||'0'), previousOrdersSnapshot=localStorage.getItem('lm_prev_orders_snap')||'[]';
        
        function showToast(message, type='info'){
            const c=document.getElementById('toast-container'); if(!c)return;
            const id='toast-'+Date.now(), types={success:'bg-emerald-600 text-white',error:'bg-red-600 text-white',warning:'bg-yellow-500 text-black',info:'bg-gray-800 text-white'}, icon={success:'check-circle',error:'alert-triangle',warning:'alert-circle',info:'info'}[type]||'info';
            const d=document.createElement('div'); d.id=id; d.className=`pointer-events-auto max-w-xs w-full rounded-xl shadow-lg px-4 py-3 text-sm flex items-start gap-3 transform transition-all duration-200 ${types[type]||types.info}`;
            d.innerHTML=`<div class="mt-0.5"><i data-lucide="${icon}" class="w-4 h-4"></i></div><div class="flex-1">${message}</div><button onclick="document.getElementById('${id}')?.remove()" class="ml-2 text-xs opacity-80 hover:opacity-100">‚úï</button>`;
            c.appendChild(d); lucide.createIcons(); setTimeout(()=>{d.classList.add('opacity-0','translate-x-2');setTimeout(()=>d.remove(),150);},3000);
        }
        function formatINR(v){ return (Number(v)||0).toLocaleString('en-IN'); }
        function getVisibleWishlistCount(){ return wishlist.filter(id=>livestock.some(item=>item._id===id)).length; }
        function saveNotifications(){ localStorage.setItem('lm_notifications',JSON.stringify(notifications)); }
        function updateNotificationBadge(){ const b=document.getElementById('notification-badge'), c=document.getElementById('clear-all-btn'); if(!b)return; b.innerText=notifications.length; if(notifications.length>0){ b.classList.remove('hidden'); if(c)c.disabled=false; } else { b.classList.add('hidden'); if(c)c.disabled=true; } }
        function renderNotifications(){
            const l=document.getElementById('notification-list'); if(!l)return;
            l.innerHTML=notifications.length===0 ? `<p class="text-center text-xs text-gray-400 py-4" id="no-notifications-msg">No new notifications.</p>` : [...notifications].reverse().map(n=>`<div class="flex items-start justify-between p-3 rounded-lg hover:bg-gray-50 transition duration-150"><div class="flex items-start gap-2 flex-1"><i data-lucide="${n.icon}" class="w-4 h-4 mt-0.5 text-${n.color}-500 flex-shrink-0"></i><div><p class="text-xs font-medium text-gray-800">${n.title}</p><p class="text-[11px] text-gray-500">${n.message}</p></div></div><button onclick="removeNotification('${n.id}')" class="text-gray-400 hover:text-gray-600 ml-2 p-1 -mt-1"><i data-lucide="x" class="w-3 h-3"></i></button></div>`).join('');
            updateNotificationBadge(); lucide.createIcons();
        }
        function toggleNotificationMenu(f){ const m=document.getElementById('notification-menu'); if(!m)return; if(typeof f==='boolean'){ if(f){ m.classList.remove('hidden','scale-95','opacity-0'); m.classList.add('scale-100','opacity-100'); }else{ m.classList.remove('scale-100','opacity-100'); m.classList.add('scale-95','opacity-0'); setTimeout(()=>m.classList.add('hidden'),300); } return; } if(m.classList.contains('hidden')){ renderNotifications(); m.classList.remove('hidden','scale-95','opacity-0'); m.classList.add('scale-100','opacity-100'); }else{ m.classList.remove('scale-100','opacity-100'); m.classList.add('scale-95','opacity-0'); setTimeout(()=>m.classList.add('hidden'),300); } }
        function removeNotification(id){ notifications=notifications.filter(n=>n.id!==id); saveNotifications(); renderNotifications(); }
        function clearAllNotifications(){ notifications=[]; saveNotifications(); renderNotifications(); showToast('All notifications cleared.','info'); }

        async function loadUserState(){
            if(!currentUser||!currentUser.id)return; try{ const r=await fetch(`${API_URL}/user/state`,{method:'GET',credentials:'include'}); if(r.ok){ const d=await r.json(); cart=d.cart||[]; wishlist=d.wishlist||[]; addresses=d.addresses||[]; if(addresses.length>0) currentAddress=addresses[0]; } }catch(e){}
        }
        async function saveUserState(){
            if(!currentUser||!currentUser.id)return; try{ await fetch(`${API_URL}/user/state`,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({cart,wishlist,addresses})}); }catch(e){}
        }

        function switchAuthView(mode){ const c=document.getElementById('auth-card'); if(!c)return; if(mode==='register') c.classList.add('show-register'); else c.classList.remove('show-register'); }
        function showAuthError(m){ const e=document.getElementById('auth-error'); if(!e)return; if(m){ e.textContent=m; e.classList.remove('hidden'); showToast(m,'error'); }else{ e.textContent=''; e.classList.add('hidden'); } }
        function showAuthScreen(){ document.getElementById('auth-screen').classList.remove('hidden'); document.getElementById('user-app').classList.add('hidden'); }
        function showApp(){ document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('user-app').classList.remove('hidden'); if(!appInitialized) initApp(); }
        function getInitials(n){ return n?n.split(' ').filter(Boolean).map(x=>x[0].toUpperCase()).join('').slice(0,2):'U'; }
        function updateProfileUI(){ document.getElementById('profile-avatar').textContent=getInitials(currentUser?.name); document.getElementById('profile-name').textContent=currentUser?.name||'User'; document.getElementById('profile-name-input').value=currentUser?.name||''; document.getElementById('profile-email-input').value=currentUser?.email||''; }
        function toggleProfileMenu(f){ const m=document.getElementById('profile-menu'); if(!m)return; if(typeof f==='boolean'){ f?m.classList.remove('hidden'):m.classList.add('hidden'); return; } m.classList.toggle('hidden'); }

        async function handleLogin(e){ e.preventDefault(); showAuthError(''); const email=document.getElementById('login-email').value.trim(), password=document.getElementById('login-password').value.trim(); if(!email||!password){ showAuthError('Enter email and password'); return; } try{ const r=await fetch(`${API_URL}/auth/login`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({email,password})}); const d=await r.json(); if(!r.ok){ showAuthError(d.message); return; } currentUser=d.user; await loadUserState(); updateProfileUI(); updateCartBadge(); updateWishlistBadge(); updateNotificationBadge(); showToast('Logged in','success'); showApp(); }catch(err){ showAuthError('Login failed'); } }
        async function handleRegister(e){ e.preventDefault(); showAuthError(''); const name=document.getElementById('register-name').value.trim(), email=document.getElementById('register-email').value.trim(), password=document.getElementById('register-password').value.trim(); if(!name||!email||!password){ showAuthError('All fields required'); return; } try{ const r=await fetch(`${API_URL}/auth/register`,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({name,email,password})}); const d=await r.json(); if(!r.ok){ showAuthError(d.message); return; } currentUser=d.user; await loadUserState(); updateProfileUI(); updateCartBadge(); updateWishlistBadge(); updateNotificationBadge(); showToast('Registered','success'); showApp(); }catch(err){ showAuthError('Registration failed'); } }
        async function handleLogout(){ try{ await fetch(`${API_URL}/auth/logout`,{method:'POST',credentials:'include'}); }catch(e){} currentUser=null; cart=[]; wishlist=[]; addresses=[]; notifications=[]; currentAddress=null; localStorage.removeItem('lm_notifications'); localStorage.removeItem('lm_prev_ls_count'); localStorage.removeItem('lm_prev_orders_snap'); updateCartBadge(); updateWishlistBadge(); updateNotificationBadge(); toggleProfileMenu(false); showToast('Logged out','info'); showAuthScreen(); }
        async function checkAuth(){ try{ const r=await fetch(`${API_URL}/auth/me`,{method:'GET',credentials:'include'}); if(r.ok){ const d=await r.json(); currentUser=d.user; await loadUserState(); updateProfileUI(); showApp(); }else showAuthScreen(); }catch(e){ showAuthScreen(); } }

        async function loadData(){
            let fls=livestock, fords=orders; const initialized=previousLivestockCount>0||JSON.parse(previousOrdersSnapshot).length>0;
            try{
                const r1=await fetch(`${API_URL}/livestock`); fls=await r1.json();
                if(initialized && fls.length>previousLivestockCount) notifications.push({id:'ls_'+Date.now(),title:'Market Update',message:`${fls.length-previousLivestockCount} new livestock!`,icon:'sheep',color:'green',timestamp:Date.now()});
                if(currentUser){ const r2=await fetch(`${API_URL}/orders`,{method:'GET',credentials:'include'}); fords=await r2.json(); const pm=JSON.parse(previousOrdersSnapshot).reduce((a,o)=>{a[o._id]=o.status;return a},{}); if(initialized){ fords.forEach(o=>{ const old=pm[o._id]; if(old&&old!==o.status) notifications.push({id:'ord_'+o._id+Date.now(),title:'Order Update',message:`Order #${String(o._id).slice(-6)} is ${o.status}`,icon:'package',color:o.status==='Delivered'?'gray':'blue',timestamp:Date.now()}); }); } }
            }catch(e){}
            const lsChg=JSON.stringify(livestock)!==JSON.stringify(fls), ordChg=JSON.stringify(orders)!==JSON.stringify(fords);
            if(lsChg) livestock=fls; if(ordChg) orders=fords;
            previousLivestockCount=livestock.length; localStorage.setItem('lm_prev_ls_count',livestock.length);
            previousOrdersSnapshot=JSON.stringify(orders.map(o=>({_id:o._id,status:o.status}))); localStorage.setItem('lm_prev_orders_snap',previousOrdersSnapshot);
            saveNotifications();
            const validIds=livestock.map(i=>i._id), clnWish=wishlist.filter(id=>validIds.includes(id)); if(clnWish.length!==wishlist.length){ wishlist=clnWish; await saveUserState(); }
            
            const active=document.querySelector('.nav-item.bg-green-600'), cv=active?active.getAttribute('onclick').replace("router('","").replace("')",""):'dashboard';
            // Only re-render if data changed to avoid blinking
            if(cv==='browse'&&lsChg) renderBrowse();
            if(cv==='orders'&&ordChg) renderOrders();
            if(cv==='dashboard'&&(lsChg||ordChg)) renderDashboard();
            if(cv==='cart') renderCart(); if(cv==='wishlist') renderWishlist(); if(cv==='addresses') renderAddresses();
            updateWishlistBadge(); updateNotificationBadge();
        }

        function router(v){
            const titleEl = document.getElementById('page-title');
            const newTitle = {dashboard:'My Dashboard',browse:'Browse Livestock',cart:'Shopping Cart',orders:'My Orders',wishlist:'My Wishlist',addresses:'Addresses',profile:'My Profile',support:'Support'}[v]||'Dashboard';
            // FIX: Prevent re-animating if already on the page
            const currentView = document.querySelector('div[id^="view-"]:not(.hidden)');
            if(currentView && currentView.id === 'view-'+v) {
                // Just refresh data, don't re-render full view unless necessary
                loadData();
                return;
            }

            loadData();
            document.getElementById('page-title').innerText=newTitle;
            ['dashboard','browse','cart','orders','wishlist','addresses','profile','support'].forEach(x=>document.getElementById('view-'+x)?.classList.add('hidden'));
            document.getElementById('view-'+v)?.classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b=>{ if(b.getAttribute('onclick').includes(v)){ b.classList.add('bg-green-600','text-white'); b.classList.remove('text-gray-600','hover:bg-gray-100'); }else{ b.classList.remove('bg-green-600','text-white'); b.classList.add('text-gray-600','hover:bg-gray-100'); } });
            
            if(v==='dashboard') renderDashboard(); if(v==='browse') renderBrowse(); if(v==='cart') renderCart(); if(v==='orders') renderOrders(); if(v==='wishlist') renderWishlist(); if(v==='addresses') renderAddresses();
            updateCartBadge(); updateWishlistBadge(); updateNotificationBadge(); lucide.createIcons();
        }

        function renderDashboard(){
            document.getElementById('dash-total-spent').innerText=formatINR(orders.reduce((s,o)=>s+(o.total||0),0));
            document.getElementById('dash-total-orders').innerText=orders.length;
            document.getElementById('dash-total-wishlist').innerText=getVisibleWishlistCount();
            document.getElementById('dash-total-cart').innerText=cart.length;
            document.getElementById('dash-total-livestock').innerText=livestock.length;
            const rc=document.getElementById('dash-recent-orders');
            rc.innerHTML=orders.length===0?'<p class="text-gray-500 text-sm">No orders yet.</p>':orders.slice(0,3).map(o=>`<div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-white rounded flex items-center justify-center text-2xl">üì¶</div><div><p class="font-bold text-gray-800">${o.items[0].name} ${o.items.length>1?'+'+(o.items.length-1)+' more':''}</p><p class="text-xs text-gray-500">#${String(o._id).slice(-6)} ‚Ä¢ ${o.date}</p></div></div><div class="text-right"><p class="font-bold">${formatINR(o.total)}</p><span class="text-xs px-2 py-1 ${getStatusColor(o.status)} rounded-full font-medium">${o.status}</span></div></div>`).join('');
        }
        function filterCategory(c){ currentCategory=c; document.querySelectorAll('.filter-btn').forEach(b=>{ if(b.innerText===c||(c==='All'&&b.innerText==='All')){ b.classList.add('bg-gray-800','text-white'); b.classList.remove('bg-white','text-gray-600','border'); }else{ b.classList.remove('bg-gray-800','text-white'); b.classList.add('bg-white','text-gray-600','border'); } }); renderBrowse(); }
        
        function renderBrowse(){
            const term=document.getElementById('search-input')?.value.toLowerCase()||'', g=document.getElementById('livestock-grid');
            const f=livestock.filter(i=>(i.name.toLowerCase().includes(term)||i.breed.toLowerCase().includes(term)) && (currentCategory==='All'||i.type===currentCategory));
            if(f.length===0){ g.innerHTML='<div class="col-span-3 text-center text-gray-500 py-10">No livestock found.</div>'; return; }
            g.innerHTML=f.map(i=>{
                const inW=wishlist.includes(i._id);
                return `<div class="bg-white p-4 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow"><div class="h-40 bg-gray-100 rounded-lg flex items-center justify-center text-6xl mb-4 relative"><img src="${API_URL}/livestock/image/${i._id}" class="w-full h-full object-cover rounded-lg" onerror="this.src='https://via.placeholder.com/160?text=No+Image'"><button onclick="toggleWishlist('${i._id}')" class="absolute top-2 right-2 p-2 bg-white rounded-full shadow-sm hover:text-red-500 ${inW?'text-red-500':'text-gray-400'}"><i data-lucide="heart" class="w-4 h-4 ${inW?'fill-current':''}"></i></button></div><div class="flex justify-between items-start mb-2"><div><h3 class="font-bold text-lg text-gray-800">${i.name}</h3><p class="text-xs text-gray-500">${i.breed} ‚Ä¢ ${i.age}</p></div><span class="bg-gray-800 text-white text-xs px-2 py-1 rounded">${i.tags?.[0]||'Good'}</span></div><div class="flex items-center justify-between mt-4"><span class="text-xl font-bold text-green-700">${formatINR(i.price)}</span><div class="flex gap-2"><button onclick="buyNow('${i._id}')" class="bg-green-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-700 transition">Buy Now</button><button onclick="addToCart('${i._id}')" class="bg-gray-900 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-800 transition">Add to Cart</button></div></div></div>`;
            }).join(''); lucide.createIcons(); window.applyRevealAndPremium();
        }

        function renderCart(){
            const c=document.getElementById('cart-items-container'), t=document.getElementById('cart-total'), h=document.getElementById('cart-count-title');
            if(cart.length===0){ c.innerHTML='<div class="text-center py-10 text-gray-400">Your cart is empty.</div>'; t.innerText='0'; h.innerText='(0 items)'; return; }
            let tot=0; const sel=cart.filter(x=>x.selected!==false); tot=sel.reduce((s,x)=>s+(x.price||0),0);
            c.innerHTML=cart.map((i,idx)=>`<div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg"><div class="flex items-center gap-4"><input type="checkbox" class="w-4 h-4 mt-1" ${i.selected!==false?'checked':''} onchange="toggleCartSelection(${idx},this.checked)"><div class="w-16 h-16 bg-white rounded-lg flex items-center justify-center text-3xl border border-gray-200"><img src="${API_URL}/livestock/image/${i._id}" class="w-full h-full object-cover rounded-lg" onerror="this.src='https://via.placeholder.com/64?text=Item'"></div><div><h4 class="font-bold text-gray-800">${i.name}</h4><p class="text-sm text-gray-500">Breed: ${i.breed}</p></div></div><div class="flex items-center gap-6"><p class="font-bold text-lg w-24 text-right">${formatINR(i.price)}</p><button onclick="removeFromCart(${idx})" class="text-red-500 hover:bg-red-50 p-2 rounded-full"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div></div>`).join('');
            t.innerText=formatINR(tot); h.innerText=`(${cart.length} items)`; lucide.createIcons();
        }

        function renderOrders(){
            const c=document.getElementById('orders-list-full'); if(!c)return; if(orders.length===0){ c.innerHTML='<div class="text-center text-gray-500">No past orders.</div>'; return; }
            c.innerHTML=orders.map(o=>{
                // FIX: Image layout and Track Button
                const firstItemId = o.items && o.items.length > 0 ? o.items[0]._id : null;
                const imageUrl = firstItemId ? `${API_URL}/livestock/image/${firstItemId}` : '';

                const itemsHtml = (o.items||[]).map(i=>`<div>${i.name} (${i.breed}) - ‚Çπ${formatINR(i.price)}</div>`).join('');
                const addressHtml = o.address ? `<div><strong>Ship to:</strong> ${o.address.name}, +91 ${o.address.phone}</div><div>${o.address.line1||o.address.line||''} ${o.address.line2?'<br/>'+o.address.line2:''}</div><div>${o.address.city||''}, ${o.address.state||''} - ${o.address.pincode||''}</div>`:'';
                const cancelBtn = o.status==='Processing' ? `<button onclick="cancelOrder('${o._id}')" class="flex-1 bg-red-100 text-red-700 px-3 py-2 rounded-lg text-sm hover:bg-red-200 transition">Cancel Order</button>` : '';
                const trackBtn = `<button onclick="openTrackModal('${o._id}')" class="flex-1 bg-blue-100 text-blue-700 px-3 py-2 rounded-lg text-sm hover:bg-blue-200 transition">Track Order</button>`;
                
                return `
                    <div class="bg-white p-4 rounded-xl border border-gray-100 mb-4">
                        <div class="flex gap-4">
                            <div class="w-20 h-20 bg-gray-100 rounded-lg flex-shrink-0 overflow-hidden border border-gray-200">
                                <img src="${imageUrl}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://via.placeholder.com/80?text=Img';">
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <p class="font-bold text-gray-800">Order #${String(o._id).slice(-6)}</p>
                                        <p class="text-xs text-gray-500">${o.date}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-green-700">${formatINR(o.total)}</p>
                                        <span class="text-xs px-2 py-1 ${getStatusColor(o.status)} rounded-full font-medium inline-block mt-1">${o.status}</span>
                                    </div>
                                </div>
                                <div class="mt-2 text-sm text-gray-700 border-t border-gray-50 pt-2">
                                    ${itemsHtml}
                                </div>
                            </div>
                        </div>

                        <div class="mt-3 pt-3 border-t border-gray-50 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                            <div class="text-sm text-gray-600">${addressHtml}</div>
                            <div class="flex gap-2 w-full md:w-auto mt-2 md:mt-0">
                                ${trackBtn}
                                ${cancelBtn}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderWishlist(){
            const g=document.getElementById('wishlist-grid'), f=livestock.filter(i=>wishlist.includes(i._id));
            if(f.length===0){ g.innerHTML='<div class="col-span-3 text-center text-gray-500">Your wishlist is empty.</div>'; return; }
            g.innerHTML=f.map(i=>`<div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm relative"><button onclick="toggleWishlist('${i._id}')" class="absolute top-4 right-4 text-red-500 bg-white rounded-full p-1 shadow hover:bg-red-50 transition"><i data-lucide="x" class="w-4 h-4"></i></button><div class="h-40 bg-gray-100 rounded-lg flex items-center justify-center text-6xl mb-4"><img src="${API_URL}/livestock/image/${i._id}" class="w-full h-full object-cover rounded-lg" onerror="this.src='https://via.placeholder.com/160?text=No+Image'"></div><h3 class="font-bold text-lg text-gray-800">${i.name}</h3><p class="text-xs text-gray-500">${i.breed} ‚Ä¢ ${i.age}</p><div class="flex items-center justify-between mt-4"><span class="text-xl font-bold text-green-700">${formatINR(i.price)}</span><div class="flex gap-2"><button onclick="buyNow('${i._id}')" class="bg-green-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-700 transition">Buy Now</button><button onclick="addToCart('${i._id}')" class="bg-gray-900 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-800 transition">Add to Cart</button></div></div></div>`).join('');
            lucide.createIcons(); window.applyRevealAndPremium();
        }

        function renderAddresses(){
            const c=document.getElementById('addresses-container'); if(!c)return;
            if(addresses.length===0){ c.innerHTML='<div class="text-sm text-gray-500 bg-gray-50 border border-dashed border-gray-200 rounded-lg p-4">No saved addresses yet.</div>'; return; }
            c.innerHTML=addresses.map((a,i)=>`
                <div class="border rounded-lg p-4 bg-gray-50">
                    <div class="flex justify-between items-start mb-2">
                        <div><p class="font-semibold text-gray-800">${a.name}</p><p class="text-xs text-gray-500">+91 ${a.phone}</p></div>
                        <div class="flex gap-2">
                            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">${a.label||'Default'}</span>
                            <button onclick="editAddress(${i})" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i data-lucide="edit" class="w-4 h-4"></i></button>
                            <button onclick="deleteAddress(${i})" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700">${a.line1||a.line}</p>${a.line2?`<p class="text-sm text-gray-700">${a.line2}</p>`:''}<p class="text-sm text-gray-700 mt-1">${a.city}, ${a.state} - ${a.pincode}</p>
                </div>`).join('');
            lucide.createIcons();
        }

        // --- CART DUPLICATION FIX ---
        function addToCart(id){
            // Check if item already exists
            if (cart.some(item => item._id === id)) {
                showToast('Item is already in your cart.', 'warning');
                return;
            }
            const item=livestock.find(i=>i._id===id);
            if(item){
                const c={_id:item._id,name:item.name,price:item.price,breed:item.breed,type:item.type,selected:true};
                cart.push(c); updateCartBadge(); saveUserState(); showToast(`${item.name} added to cart`,'success');
                if(document.querySelector('.nav-item.bg-green-600')?.getAttribute('onclick').includes('dashboard')) renderDashboard();
            }
        }

        function removeFromCart(i){ cart.splice(i,1); renderCart(); updateCartBadge(); saveUserState(); }
        function toggleCartSelection(i,c){ if(cart[i]) cart[i].selected=c; saveUserState(); renderCart(); }
        function toggleWishlist(id){ const i=wishlist.indexOf(id); if(i===-1){ if(!wishlist.includes(id)){ wishlist.push(id); showToast('Added to wishlist','success'); } }else{ wishlist.splice(i,1); showToast('Removed from wishlist','info'); } saveUserState(); updateWishlistBadge(); const a=document.querySelector('.nav-item.bg-green-600')?.getAttribute('onclick'); if(a.includes('wishlist')) renderWishlist(); if(a.includes('browse')) renderBrowse(); if(a.includes('dashboard')) renderDashboard(); }
        function buyNow(id){
            const item=livestock.find(i=>i._id===id);
            if(item){
                // For 'Buy Now', we replace the cart or just add it? Usually standard flow: add and go to cart.
                // If it's already there, just go to cart.
                if(!cart.some(c=>c._id===id)){
                    cart=[{_id:item._id,name:item.name,price:item.price,breed:item.breed,type:item.type,selected:true}];
                } else {
                    // Item exists, ensure selected?
                    // Simplified: just update state
                }
                updateCartBadge(); saveUserState(); showToast(`${item.name} ready to buy`,'success'); router('cart'); setTimeout(()=>checkout(),500);
            }
        }
        function openAddressModal(i){ editingAddressIndex=i!==undefined?i:-1; const m=document.getElementById('address-modal'), t=document.getElementById('address-modal-title'); if(!m)return; if(editingAddressIndex>=0&&addresses[editingAddressIndex]){ t.innerText='Edit Address'; const a=addresses[editingAddressIndex]; document.getElementById('addr-name').value=a.name; document.getElementById('addr-phone').value=a.phone; document.getElementById('addr-line').value=a.line1||a.line; document.getElementById('addr-city').value=a.city; document.getElementById('addr-state').value=a.state; document.getElementById('addr-pincode').value=a.pincode; }else{ t.innerText='Add New Address'; document.getElementById('address-form').reset(); } m.classList.remove('hidden'); m.classList.add('flex'); }
        function closeAddressModal(){ const m=document.getElementById('address-modal'); if(!m)return; m.classList.add('hidden'); m.classList.remove('flex'); editingAddressIndex=-1; }
        function editAddress(i){ openAddressModal(i); }
        
        // --- DELETE ADDRESS LOGIC ---
        async function deleteAddress(index) {
            if(confirm("Are you sure you want to delete this address?")) {
                addresses.splice(index, 1);
                // Update current address if needed
                if (addresses.length > 0) currentAddress = addresses[0];
                else currentAddress = null;
                
                await saveUserState();
                renderAddresses();
                showToast("Address deleted", "info");
            }
        }

        async function submitAddress(e){ e.preventDefault(); const name=document.getElementById('addr-name').value.trim(), phone=document.getElementById('addr-phone').value.trim(), line=document.getElementById('addr-line').value.trim(), city=document.getElementById('addr-city').value.trim(), state=document.getElementById('addr-state').value.trim(), pincode=document.getElementById('addr-pincode').value.trim(); if(!name||!phone||!line||!city||!state||!pincode){ showToast('Fill all fields','warning'); return; } if(!/^[0-9]{10}$/.test(phone)){ showToast('Invalid phone','warning'); return; } if(!/^[0-9]{6}$/.test(pincode)){ showToast('Invalid pincode','warning'); return; } const ad={name,phone,line1:line,city,state,pincode,label:addresses.length===0?'Default':`Address ${addresses.length+1}`}; if(editingAddressIndex>=0){ addresses[editingAddressIndex]={...addresses[editingAddressIndex],...ad}; showToast('Updated','success'); }else{ addresses.push(ad); showToast('Added','success'); } if(!currentAddress||editingAddressIndex===0) currentAddress=addresses[0]; await saveUserState(); renderAddresses(); closeAddressModal(); if(pendingCheckoutItems){ await createOrder(pendingCheckoutItems); pendingCheckoutItems=null; } }
        async function checkout(){ if(cart.length===0){ showToast('Cart empty','warning'); return; } const items=cart.filter(x=>x.selected!==false); if(items.length===0){ showToast('Select items','warning'); return; } if(addresses.length===0){ pendingCheckoutItems=items; openAddressModal(); return; } if(!currentAddress) currentAddress=addresses[0]; await createOrder(items); }
        async function createOrder(items){ const t=items.reduce((s,i)=>s+(i.price||0),0); try{ const r=await fetch(`${API_URL}/payment/create`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:t})}); const d=await r.json(); if(!r.ok){ showToast(d.message,'error'); return; } showPaymentUI(d.upiString,d.paymentId,items,t); }catch(e){ showToast('Payment error','error'); } }
        function updateCartBadge(){ const bs=[document.getElementById('cart-badge'),document.getElementById('header-cart-badge')]; bs.forEach(b=>{ if(!b)return; b.innerText=cart.length; if(cart.length>0)b.classList.remove('hidden'); else b.classList.add('hidden'); }); }
        function updateWishlistBadge(){ const b=document.getElementById('wishlist-badge'); if(!b)return; b.innerText=getVisibleWishlistCount(); if(getVisibleWishlistCount()>0)b.classList.remove('hidden'); else b.classList.add('hidden'); }
        function getStatusColor(s){ if(s==='Shipped')return 'bg-blue-100 text-blue-700'; if(s==='Delivered')return 'bg-gray-800 text-white'; if(s==='Processing')return 'bg-yellow-100 text-yellow-800'; if(s==='Cancelled')return 'bg-red-100 text-red-700'; return 'bg-gray-100 text-gray-800'; }
        function initApp(){ if(appInitialized)return; appInitialized=true; updateCartBadge(); updateWishlistBadge(); updateNotificationBadge(); const d=document.getElementById('current-date'); if(d) d.innerText=new Date().toLocaleDateString('en-IN',{weekday:'long',year:'numeric',month:'short',day:'numeric'}); router('dashboard'); }
        function attachEventListeners(){ const l=document.getElementById('login-form'), r=document.getElementById('register-form'); if(l) l.addEventListener('submit',handleLogin); if(r) r.addEventListener('submit',handleRegister); document.addEventListener('click',e=>{ const m=document.getElementById('profile-menu'), b=document.getElementById('profile-button'); if(m&&b&&!m.contains(e.target)&&!b.contains(e.target)) toggleProfileMenu(false); const nm=document.getElementById('notification-menu'), nb=document.getElementById('notification-button'); if(nm&&nb&&!nm.contains(e.target)&&!nb.contains(e.target)) toggleNotificationMenu(false); }); }
        document.addEventListener('DOMContentLoaded',()=>{ attachEventListeners(); checkAuth(); lucide.createIcons(); });

        // --- TRACK ORDER LOGIC ---
        function openTrackModal(orderId) {
            const order = orders.find(o => o._id === orderId);
            if(!order) return;
            
            const modal = document.getElementById('track-modal');
            const content = document.getElementById('track-content');
            
            // Dummy timeline
            const steps = [
                { status: 'Processing', label: 'Order Placed & Processing' },
                { status: 'Shipped', label: 'Shipped from Farm' },
                { status: 'Delivered', label: 'Delivered to Address' }
            ];
            
            let currentStepIndex = steps.findIndex(s => s.status === order.status);
            if(currentStepIndex === -1) currentStepIndex = 0; // Default processing
            
            const stepsHtml = steps.map((s, idx) => {
                const isActive = idx <= currentStepIndex;
                const isCurrent = idx === currentStepIndex;
                const colorClass = isActive ? 'bg-green-600 border-green-600 text-white' : 'bg-white border-gray-300 text-gray-400';
                
                return `
                <div class="flex items-start gap-4 relative">
                    <div class="flex flex-col items-center">
                        <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center z-10 ${colorClass}">
                            ${isActive ? '<i data-lucide="check" class="w-4 h-4"></i>' : (idx + 1)}
                        </div>
                        ${idx < steps.length - 1 ? `<div class="w-0.5 h-10 ${isActive ? 'bg-green-600' : 'bg-gray-200'} -my-1"></div>` : ''}
                    </div>
                    <div class="pt-1">
                        <p class="font-semibold ${isActive ? 'text-gray-900' : 'text-gray-400'}">${s.label}</p>
                        ${isCurrent ? '<p class="text-xs text-green-600">Current Status</p>' : ''}
                    </div>
                </div>
                `;
            }).join('');
            
            content.innerHTML = `
                <div class="border-b pb-4 mb-4">
                    <p class="font-bold">Order #${String(order._id).slice(-6)}</p>
                    <p class="text-sm text-gray-500">Expected Delivery: Within 3-5 days</p>
                </div>
                <div class="space-y-0">
                    ${stepsHtml}
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        }

        function closeTrackModal() {
            const modal = document.getElementById('track-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showPaymentUI(s,id,it,t){ document.querySelectorAll('.lm-pay-popup').forEach(e=>e.remove()); const p=document.createElement("div"); p.className="lm-pay-popup fixed inset-0 flex items-center justify-center bg-black/60 z-50 px-4"; p.innerHTML=`<div class="bg-white w-full max-w-md p-6 rounded-2xl text-gray-800"><h2 class="text-xl font-bold mb-3">Complete Payment</h2><p class="text-sm text-gray-500 mb-4">Pay using UPI.</p><div class="grid grid-cols-2 gap-3 mb-4"><a href="${s}" class="block rounded-lg p-3 text-center font-semibold border">PhonePe</a><a href="${s}" class="block rounded-lg p-3 text-center font-semibold border">GPay</a><a href="${s}" class="block rounded-lg p-3 text-center font-semibold border">Paytm</a><a href="${s}" class="block rounded-lg p-3 text-center font-semibold border">BHIM</a></div><div class="mt-2 text-center"><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(s)}" class="mx-auto rounded-lg border"/><p class="text-xs text-gray-500 mt-2">Scan & Pay ‚Ä¢ ‚Çπ${t}</p></div><button id="lm-paid-btn" class="w-full bg-green-600 text-white py-3 mt-6 rounded-xl font-bold">I Have Paid</button><button id="lm-cancel-btn" class="w-full text-gray-500 mt-3 text-sm">Cancel</button></div>`; document.body.appendChild(p); document.getElementById('lm-paid-btn').onclick=()=>confirmPayment(id,it,t); document.getElementById('lm-cancel-btn').onclick=()=>document.querySelectorAll('.lm-pay-popup').forEach(e=>e.remove()); }
        async function confirmPayment(pid,it,t){ try{ const r=await fetch(`${API_URL}/payment/confirm`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentId:pid})}); const d=await r.json(); if(!r.ok||!d.success){ showToast(d.message,'error'); return; } const o=await fetch(`${API_URL}/orders`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:it.map(i=>({_id:i._id,name:i.name,price:i.price,breed:i.breed})),total:t,date:new Date().toLocaleDateString('en-IN',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}),address:currentAddress,status:"Processing"})}); if(!o.ok){ showToast('Order creation failed','error'); return; } cart=[]; await saveUserState(); showToast('Order Placed!','success'); document.querySelectorAll('.lm-pay-popup').forEach(e=>e.remove()); await loadData(); router('orders'); }catch(e){ showToast('Confirm failed','error'); } }
        async function cancelOrder(id){ try{ const r=await fetch(`${API_URL}/orders/${id}/cancel`,{method:"PUT",credentials:"include"}); const d=await r.json(); if(!r.ok){ showToast(d.message,'error'); return; } showToast('Order cancelled','success'); await loadData(); router('orders'); }catch(e){ showToast('Cancel failed','error'); } }
    </script>
    <script>
    (function(){
      // animatePage: adds page-enter classes then activates
      window.animatePage = function(viewId){
        try {
          const view = document.getElementById(viewId);
          if(!view) return;
          view.classList.add("page-enter");
          requestAnimationFrame(()=> {
            view.classList.add("page-enter-active");
            setTimeout(()=> {
              view.classList.remove("page-enter", "page-enter-active");
            }, 800);
          });
        } catch(e){ console.error("animatePage error", e); }
      };

      // Reveal observer for cards
      const revealObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add("reveal-visible");
            revealObserver.unobserve(entry.target);
          }
        });
      }, { threshold: 0.18 });

      window.applyRevealAndPremium = function(){
        try {
          const grid = document.getElementById('livestock-grid');
          if(!grid) return;
          Array.from(grid.children).forEach(el => {
            el.classList.add('reveal','card-premium');
            revealObserver.observe(el);
          });
        } catch(e){ console.error("applyReveal error", e); }
      };

      if (window.router) {
        const __old_router = window.router.bind(window);
        window.router = function(viewName){
          try {
            __old_router(viewName);
          } catch(e){
            console.error("router wrapper old failed", e);
          }
          
          // BLINKING FIX: Only animate if the view is ACTUALLY changing visibility state
          // The main router logic now manages 'hidden' class. 
          // We check if the element has 'page-enter' running or simply re-run animation
          // But to prevent hard blinking, we rely on the CSS transitions in 'auth-panel' etc if applicable.
          // Here we just re-trigger the page enter slide up.
          
          const view = document.getElementById('view-' + viewName);
          // If the view is already visible and we are just refreshing data (handled inside main router now), 
          // this wrapper might be redundant for clicks on the SAME nav item. 
          // However, assuming the main router logic toggles 'hidden', we proceed.
          
          try {
             animatePage('view-' + viewName);
          } catch(e){ /* ignore */ }
          
          if (viewName === 'browse') {
            setTimeout(() => { applyRevealAndPremium(); }, 100);
          } else {
            setTimeout(() => { applyRevealAndPremium(); }, 200);
          }
          setTimeout(() => {
            document.querySelectorAll('button:not(.btn-press)').forEach(b => b.classList.add('btn-press'));
            document.querySelectorAll('.bg-green-600, .bg-gray-900').forEach(b => b.classList.add('btn-glow'));
          }, 150);
        };
      } else {
        const waitRouter = setInterval(() => {
          if (window.router) {
            clearInterval(waitRouter);
            const __old_router = window.router.bind(window);
            window.router = function(viewName){
              try { __old_router(viewName); } catch(e){}
              try { animatePage('view-' + viewName); } catch(e){}
              if (viewName === 'browse') setTimeout(() => { applyRevealAndPremium(); }, 100);
              else setTimeout(() => { applyRevealAndPremium(); }, 200);
              setTimeout(() => {
                document.querySelectorAll('button:not(.btn-press)').forEach(b => b.classList.add('btn-press'));
                document.querySelectorAll('.bg-green-600, .bg-gray-900').forEach(b => b.classList.add('btn-glow'));
              }, 150);
            };
          }
        }, 150);
      }

      if (window.showToast) {
        const _oldToast = window.showToast.bind(window);
        window.showToast = function(message, type){
          _oldToast(message, type);
          setTimeout(() => {
            try {
              const container = document.getElementById('toast-container');
              if (!container) return;
              const last = container.lastElementChild;
              if (last) last.classList.add('toast-anim');
            } catch(e){ console.error("toast patch error", e); }
          }, 10);
        };
      } else {
        const waitToast = setInterval(() => {
          if (window.showToast) {
            clearInterval(waitToast);
            const _oldToast = window.showToast.bind(window);
            window.showToast = function(message, type){
              _oldToast(message, type);
              setTimeout(() => {
                try {
                  const container = document.getElementById('toast-container');
                  if (!container) return;
                  const last = container.lastElementChild;
                  if (last) last.classList.add('toast-anim');
                } catch(e){}
              }, 120);
            };
          }
        }, 120);
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('button:not(.btn-press)').forEach(b => b.classList.add('btn-press'));
        document.querySelectorAll('.bg-green-600, .bg-gray-900').forEach(b => b.classList.add('btn-glow'));
        setTimeout(() => { applyRevealAndPremium(); }, 300);
      });

    })();
    </script>
</body>
</html>
